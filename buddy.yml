- pipeline: "test & deploy"
  trigger_mode: "ON_EVERY_PUSH"
  ref_type: "BRANCH"
  ref_name: "develop"
#   trigger_condition: "ON_CHANGE_AT_PATH"
#   trigger_condition_paths: "."
  actions:
#   - action: "Execute: npm test"
#     type: "BUILD"
#     working_directory: "/buddy/buddy-ci-demo"
#     docker_image_name: "library/node"
#     docker_image_tag: "10"
#     execute_commands:
#     - "npm install"
#     - "npm rebuild node-sass"
#     - "gulp sass"
#     - "npm test"
#     setup_commands:
#     - "npm install -g gulp grunt-cli"
#     volume_mappings:
#     - "/:/buddy/buddy-ci-demo"
#     trigger_condition: "ALWAYS"
#     shell: "SH"
#     run_next_parallel: true

  - action: "Execute: python test"
    type: "BUILD"
    working_directory: "/buddy/buddy-ci-demo"
    docker_image_name: "library/python"
    docker_image_tag: "3.6"
    execute_commands:
    - "pip install cryptography setuptools==45 selenium psycopg2"
    - "pip install -r requirements.txt"
    - "python dbmigration.py db init && python dbmigration.py db migrate"
    - "nosetests --with-coverage --cover-package=bucketlist"
    setup_commands:
    - "apt-get update && apt-get install -y python-pytest"
    services:
    - type: "POSTGRE_SQL"
      version: "9.5.3"
      connection:
        host: "postgres"
        port: 5432
        user: "root"
        password: "root"
        db: "reactdb"
    volume_mappings:
    - "/:/buddy/buddy-ci-demo"
    trigger_condition: "ALWAYS"
    shell: "SH"


#   - action: "Execute: packer build"
#     type: "BUILD"
#     docker_image_name: "mukiibi/buddy-ci-image"
#     docker_image_tag: "v2"
#     execute_commands:
#     - "/packer build packer.json"

#   - action: "Execute: terraform plan"
#     type: "BUILD"
#     docker_image_name: "mukiibi/buddy-ci-image"
#     docker_image_tag: "v2"
#     execute_commands:
#     - "terraform plan"

#   - action: "Execute: terraform apply"
#     type: "BUILD"
#     docker_image_name: "mukiibi/buddy-ci-image"
#     docker_image_tag: "v2"
#     execute_commands:
#     - "terraform apply -auto-approve"

# - pipeline: "build"
#   trigger_mode: "ON_EVERY_PUSH"
#   ref_name: "*"